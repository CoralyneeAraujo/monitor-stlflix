<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monitoramento STLFLIX</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1420;
      --card:#121a2a;
      --muted:#90a0b7;
      --text:#e6edf7;
      --primary:#3b82f6;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --ring: 0 0 0 3px rgba(59,130,246,.25);
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --border: #1e293b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,var(--bg),#090d14 60%) fixed; color:var(--text);
    }

    .topbar{display:flex; align-items:center; justify-content:space-between; padding:16px 24px; border-bottom:1px solid var(--border); background:rgba(17,24,39,.6); backdrop-filter: blur(6px); position:sticky; top:0; z-index:40}
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.2px}
    .pulse{width:22px;height:22px;border-radius:999px; background:conic-gradient(from 0deg,#34d399, #2563eb, #34d399); display:grid; place-items:center; animation:spin 6s linear infinite}
    .pulse::after{content:""; width:12px;height:12px;border-radius:999px;background:#0b141f; border:3px solid #34d399}
    @keyframes spin{to{transform:rotate(1turn)}}
    .actions{display:flex; gap:10px; align-items:center}
    .pill{display:inline-flex; align-items:center; gap:8px; font-weight:600; font-size:13px; padding:8px 10px; border-radius:999px; background:#0b1420; border:1px solid var(--border)}
    .dot{width:8px;height:8px;border-radius:999px; display:inline-block}
    .dot.good{background:var(--good)}
    .dot.bad{background:var(--bad)}
    .dot.info{background:#60a5fa}
    .btn{background:var(--primary); color:#fff; border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; box-shadow: var(--shadow)}
    .btn:focus{outline:none; box-shadow: var(--shadow), var(--ring)}
    .btn.secondary{background:#0b1420; border:1px solid var(--border); color:var(--text)}
.wrap{
  max-width:none;        /* ocupa a largura inteira */
  width:100%;
  margin:20px 0;         /* tira centraliza√ß√£o autom√°tica */
  padding:0 16px;        /* borda interna discreta */
}

.grid{
  display:grid;
  gap:18px;
  /* colunas responsivas, mas sem ‚Äúcentro el√°stico‚Äù ‚Äî gruda na esquerda */
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  justify-content:start; /* garante alinhamento √† esquerda */
}

    .card{background:var(--card); border:1px solid var(--border); border-radius:18px; padding:18px; box-shadow: var(--shadow); position:relative; overflow:hidden; min-height:200px}
    .card .statusLamp{position:absolute; right:14px; top:14px; width:12px; height:12px; border-radius:999px; background:#334155; box-shadow:0 0 0 3px rgba(255,255,255,.02)}
    .card.online .statusLamp{background:var(--good)}
    .card.error .statusLamp{background:var(--bad)}
    .card.paused .statusLamp{background:#60a5fa}
    .title{font-weight:700; font-size:18px; margin:4px 0 10px; margin-left:36px;}
    .badge{display:inline-flex; gap:6px; align-items:center; font-size:12px; font-weight:700; padding:4px 10px; border-radius:999px; border:1px solid var(--border); background:#0c1220; color:var(--muted)}
    .badge.ok{color:#16a34a; border-color:rgba(34,197,94,.25); background:rgba(34,197,94,.08)}
    .badge.paused{color:#60a5fa; border-color:rgba(96,165,250,.25); background:rgba(96,165,250,.08)}
    .badge.err{color:#ef4444; border-color:rgba(239,68,68,.25); background:rgba(239,68,68,.08)}

    .link{color:#93c5fd; text-decoration:none; word-break:break-all}
    .meta{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:12px; font-size:13px; color:var(--muted)}
    .k{display:flex; justify-content:space-between; border-top:1px dashed var(--border); padding-top:8px; margin-top:8px}

    .dropdown{position:absolute; left:12px; top:10px; z-index:5; }
    .kebab{width:28px;height:28px;border-radius:8px; background:#0b1420; border:1px solid var(--border); display:grid; place-items:center; cursor:pointer}
    .menu{position:absolute; margin-top:6px; width:190px; background:#0b1420; border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow); display:none; z-index:20}
    .menu.open{display:block}
    .menu a, .menu button{all:unset; display:flex; gap:10px; align-items:center; padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.04); font-size:14px}
    .menu a:last-child, .menu button:last-child{border-bottom:none}
    .menu a:hover, .menu button:hover{background:#0e1626}

    .empty{border:1px dashed var(--border); border-radius:16px; padding:22px; text-align:center; color:var(--muted)}

    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.55); z-index:50}
    .modal.open{display:grid}
    .dialog{width:min(520px, 94vw); background:var(--panel); border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow); padding:18px}
    .dialog h3{margin:2px 0 14px; font-size:18px}
    .row{display:grid; grid-template-columns:1fr; gap:10px}
    .input{background:#0c1220; color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px}
    .input:focus{outline:none; box-shadow: var(--ring); border-color:#334155}
    .two{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .actions-bar{display:flex; justify-content:flex-end; gap:10px; margin-top:12px}

    .logs-list{display:grid; gap:10px; margin-top:6px; max-height:70vh; overflow:auto}
    .log-row{display:grid; grid-template-columns: 120px 160px 90px 90px 70px; gap:12px; align-items:center; padding:12px 14px; border:1px solid var(--border); border-radius:12px; background:#0d1525}
    .chip{display:inline-flex; align-items:center; justify-content:center; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; border:1px solid var(--border)}
    .chip.ok{color:#16a34a; background:rgba(34,197,94,.08); border-color:rgba(34,197,94,.25)}
    .chip.err{color:#ef4444; background:rgba(239,68,68,.08); border-color:rgba(239,68,68,.25)}

    .toast{position:fixed; right:18px; bottom:18px; background:#0b1420; border:1px solid var(--border); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); display:none}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="pulse" aria-hidden="true"></div>
      <div>
        <div style="font-size:14px; color:var(--muted); font-weight:600; line-height:1">STLFLIX - MONITORAMENTO</div>
        <div style="font-size:11px; color:#7f8ea8; line-height:1">Monitora√ß√£o em Tempo Real</div>
      </div>
    </div>
    <div class="actions">
      <div class="pill"><span class="dot good"></span><span id="pillOnline">0 Online</span></div>
      <div class="pill"><span class="dot bad"></span><span id="pillError">0 Error</span></div>
      <div class="pill"><span class="dot info"></span><span id="pillPaused">0 Pausados</span></div>
      <button class="btn" id="openModal">+ Adicionar Monitor</button>
    </div>
  </div>

  <div class="wrap">
    <div id="cards" class="grid"></div>
    <div id="empty" class="empty" style="display:none">Nenhum monitor ainda. Clique em <strong>+ Adicionar Monitor</strong> para come√ßar.</div>
  </div>

  <div id="modal" class="modal" aria-modal="true" role="dialog">
    <div class="dialog">
      <h3>Adicionar Novo Monitor</h3>
      <div class="row">
        <label>
          <div style="font-size:12px; color:var(--muted); margin-bottom:4px">Nome do Monitor</div>
          <input id="nameInput" class="input" placeholder="My Website" />
        </label>
        <label>
          <div style="font-size:12px; color:var(--muted); margin-bottom:4px">URL</div>
          <input id="urlInput" class="input" placeholder="https://example.com" />
        </label>
        <div class="two">
          <label>
            <div style="font-size:12px; color:var(--muted); margin-bottom:4px">Tipo</div>
            <select id="typeInput" class="input">
              <option value="website">Website</option>
              <option value="api">API</option>
            </select>
          </label>
          <label>
            <div style="font-size:12px; color:var(--muted); margin-bottom:4px">Intervalo (s)</div>
            <input id="intervalInput" class="input" type="number" min="5" value="30" />
          </label>
        </div>
      </div>
      <div class="actions-bar">
        <button class="btn secondary" id="cancelModal">Cancelar</button>
        <button class="btn" id="submitModal">Adicionar Monitor</button>
      </div>
    </div>
  </div>

  <div id="logsModal" class="modal" aria-modal="true" role="dialog">
    <div class="dialog" style="width:min(960px,94vw)">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <h3 id="logsTitle">Logs</h3>
        <button id="closeLogs" class="btn secondary">Fechar</button>
      </div>
      <div class="logs-list" id="logsList"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    'use strict';
    // usa sempre o mesmo host do front (Railway ou local)
	const api = (p, opts = {}) => fetch(p, opts);
// wss em https, ws em http
	const wsUrl = () => location.origin.replace(/^http/, 'ws') + '/ws';

    const cardsEl = document.getElementById('cards');
    const emptyEl = document.getElementById('empty');
    const toast = document.getElementById('toast');

    const modal = document.getElementById('modal');
    const openModalBtn = document.getElementById('openModal');
    const cancelModalBtn = document.getElementById('cancelModal');
    const submitModalBtn = document.getElementById('submitModal');
    const nameInput = document.getElementById('nameInput');
    const urlInput = document.getElementById('urlInput');
    const typeInput = document.getElementById('typeInput');
    const intervalInput = document.getElementById('intervalInput');

    const logsModal = document.getElementById('logsModal');
    const logsTitle = document.getElementById('logsTitle');
    const logsList = document.getElementById('logsList');
    const closeLogsBtn = document.getElementById('closeLogs');

    const pillOnline = document.getElementById('pillOnline');
    const pillError  = document.getElementById('pillError');
    const pillPaused = document.getElementById('pillPaused');

    let targets = [];
    const lastOk = new Map();
    const lastLatency = new Map();
    const lastUptime = new Map();
    const lastWhen = new Map(); // <-- here

    function showToast(msg){
      toast.textContent = msg;
      toast.style.display = 'block';
      setTimeout(()=> toast.style.display = 'none', 2400);
    }

    function normalizeUrl(u){ if(!u) return u; return /^https?:\/\//i.test(u) ? u : 'https://' + u; }

    function cardStatus(t){
      if(!t.enabled) return 'paused';
      const ok = lastOk.get(t.id);
      if(ok === undefined) return 'paused';
      return ok ? 'online' : 'error';
    }

    function toDate(val){
      if(val==null) return null;
      if(typeof val === 'number'){ const ms = val < 1e12 ? val*1000 : val; return new Date(ms); }
      const d = new Date(val);
      if(!isNaN(d)) return d;
      const m = String(val).match(/^(\\d{4})-(\\d{2})-(\\d{2})[ T](\\d{2}):(\\d{2})(?::(\\d{2}))?/);
      if(m) return new Date(+m[1], +m[2]-1, +m[3], +m[4], +m[5], +(m[6]||0));
      return null;
    }
    function fmtDateTime(d){
      if(!d) return '--';
      const pad = (n)=> String(n).padStart(2,'0');
      return pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear()+' '+pad(d.getHours())+':'+pad(d.getMinutes())+':'+pad(d.getSeconds());
    }
    function fmtTime(d){
      if(!d) return '--';
      const pad = (n)=> String(n).padStart(2,'0');
      return pad(d.getHours())+':'+pad(d.getMinutes())+':'+pad(d.getSeconds());
    }

    function pick(o, keys){ for(const k of keys){ if(o && o[k]!=null) return o[k]; } return null; }
  function renderCards(){
  cardsEl.innerHTML = '';

  if (!targets.length) {
    emptyEl.style.display = 'block';
    updatePills();
    return;
  }

  emptyEl.style.display = 'none';

  // Ordena para que os rec√©m-criados apare√ßam na primeira linha
  const ordered = targets
    .slice()
    .sort((a, b) => {
      const ta = a.created_at ? new Date(a.created_at).getTime() : (a.id || 0);
      const tb = b.created_at ? new Date(b.created_at).getTime() : (b.id || 0);
      return tb - ta; // mais novo primeiro
    });

  for (const t of ordered) {
    const s   = cardStatus(t);
    const lat = lastLatency.get(t.id);
    const up  = lastUptime.get(t.id);
    const when= lastWhen.get(t.id);

    const card = document.createElement('div');
    card.className = 'card ' + s;
    card.innerHTML = ''
      + '<div class="dropdown">'
      + '  <button class="kebab" aria-haspopup="true" aria-expanded="false" title="Options">‚ãÆ</button>'
      + '  <div class="menu" role="menu">'
      + '    <a href="' + t.url + '" target="_blank" rel="noopener">üîó Visitar Site</a>'
      + (t.enabled ? '    <button data-action="pause">‚è∏ Pausar</button>' : '    <button data-action="resume">‚ñ∂ Resume</button>')
      + '    <button data-action="viewlogs">üìú Visualizar Logs</button>'
      + '    <button data-action="delete">üóë Remover</button>'
      + '  </div>'
      + '</div>'
      + '<div class="statusLamp"></div>'
      + '<div class="title">' + t.name + '</div>'
      + '<div class="badge ' + (s === 'online' ? 'ok' : (s === 'paused' ? 'paused' : 'err')) + '">' + (s === 'online' ? 'Online' : (s === 'paused' ? 'Paused' : 'Error')) + '</div>'
      + '<div style="margin-top:12px"><a class="link" href="' + t.url + '" target="_blank" rel="noopener">' + t.url + '</a></div>'
      + '<div class="meta">'
      + '  <div>Lat√™ncia<br><strong>' + (lat!=null ? (lat + 'ms') : '--') + '</strong></div>'
      + '  <div>Uptime<br><strong>' + (up!=null ? up.toFixed(1) + '%' : '--') + '</strong></div>'
      + '</div>'
      + '<div class="k"><span>Intervalo</span><span>' + (t.interval_sec || 30) + 's</span></div>'
      + '<div class="k"><span>√öltima Execu√ß√£o</span><span>' + (when ? fmtDateTime(when) : '--') + '</span></div>';

    const kebab = card.querySelector('.kebab');
    const menu  = card.querySelector('.menu');

    kebab.addEventListener('click', (e)=>{
      e.stopPropagation();
      const isOpen = menu.classList.contains('open');
      document.querySelectorAll('.menu.open').forEach(m=>m.classList.remove('open'));
      if(!isOpen){ menu.classList.add('open'); }
    });
    document.addEventListener('click', ()=> menu.classList.remove('open'));

    menu.querySelectorAll('button').forEach(btn => {
      const action = btn.getAttribute('data-action');
      btn.addEventListener('click', async ()=>{
        try{
          if(action==='pause'){
            const r = await api('/api/targets/' + t.id + '/pause', {method:'POST'});
            if(!r.ok) throw new Error('Falha ao pausar');
            showToast('Monitor pausado');
          }else if(action==='resume'){
            const r = await api('/api/targets/' + t.id + '/resume', {method:'POST'});
            if(!r.ok) throw new Error('Falha ao retomar');
            showToast('Monitor retomado');
          }else if(action==='delete'){
            if(!confirm('Remover este monitor?')) return;
            const r = await api('/api/targets/' + t.id, {method:'DELETE'});
            if(r.status!==204) throw new Error('Falha ao remover');
            showToast('Monitor removido');
          }else if(action==='viewlogs'){
            await openLogs(t);
            return;
          }
          await loadTargets();
        }catch(e){ showToast(e.message); }
      });
    });

    cardsEl.appendChild(card);
  }

  updatePills();
}


    function updatePills(){
      let on=0, err=0, paused=0;
      for(const t of targets){
        const s = cardStatus(t);
        if(s==='online') on++;
        else if(s==='error') err++;
        else paused++;
      }
      pillOnline.textContent = on + ' Online';
      pillError.textContent  = err + ' Error';
      pillPaused.textContent = paused + ' Paused';
    }

    async function fetchLastStateForTarget(id){
      try{
        const r = await api('/api/logs?targetId=' + id + '&limit=100');
        if(!r.ok) return;
        const items = await r.json();
        if(!Array.isArray(items) || items.length===0) return;
        const first = items[0] || {};
        const okNow = (first.ok === 1) || (first.ok === true);
        lastOk.set(id, okNow);
        const rt = pick(first, ['response_time_ms','rt','latency_ms']);
        lastLatency.set(id, rt);
        // when
        const whenRaw = pick(first, ['timestamp','created_at','time','checked_at','date']);
        const d = toDate(whenRaw);
        if(d) lastWhen.set(id, d);
        // uptime
        const total = items.length;
        let oks = 0;
        for(const x of items){ if(x.ok === 1 || x.ok === true) oks++; }
        lastUptime.set(id, total ? (oks/total)*100 : null);
      }catch(e){ console.warn(e); }
    }

    async function loadTargets(){
      try{
        const r = await api('/api/targets');
        targets = await r.json();
        await Promise.all(targets.map(t => fetchLastStateForTarget(t.id)));
        renderCards();
      }catch(e){
        cardsEl.innerHTML = '<div class="empty">Falha ao carregar monitores.</div>';
        console.error(e);
      }
    }

    const openModal = () => { modal.classList.add('open'); nameInput.focus(); };
    const closeModal = () => { modal.classList.remove('open'); };
    openModalBtn.addEventListener('click', openModal);
    cancelModalBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => { if(e.target === modal) closeModal(); });

    submitModalBtn.addEventListener('click', async () => {
      const name = nameInput.value.trim();
      const url = normalizeUrl(urlInput.value.trim());
      if(!name || !url) return showToast('Preencha nome e URL');
      const data = { name, url, type: typeInput.value, interval_sec: Number(intervalInput.value||30) };
      try{
        const r = await api('/api/targets', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
        if(!r.ok){
          let j = {}; try{ j = await r.json(); }catch{}
          throw new Error(j.message || j.error || 'Falha ao criar');
        }
        nameInput.value = ''; urlInput.value = '';
        closeModal();
        showToast('Monitor adicionado');
        await loadTargets();
      }catch(e){ showToast(e.message); }
    });

    function closeLogs(){ logsModal.classList.remove('open'); }
    closeLogsBtn.addEventListener('click', closeLogs);
    logsModal.addEventListener('click', (e)=>{ if(e.target===logsModal) closeLogs(); });

    async function openLogs(target){
      try{
        logsTitle.textContent = 'Logs for ' + target.name;
        logsList.innerHTML = '<div class="empty">Carregando...</div>';
        logsModal.classList.add('open');
        const r = await api('/api/logs?targetId=' + target.id + '&limit=200');
        if(!r.ok){ logsList.innerHTML = '<div class="empty">Falha ao carregar logs.</div>'; return; }
        const items = await r.json();
        if(!Array.isArray(items) || items.length===0){
          logsList.innerHTML = '<div class="empty">Sem logs.</div>'; return;
        }
        logsList.innerHTML = '';
        for(const it of items){
          const ok = (it.ok === 1) || (it.ok === true);
          const code = pick(it, ['http_status_code','status_code','status']);
          const rt = pick(it, ['response_time_ms','rt','latency_ms']);
          const whenRaw = pick(it, ['timestamp','created_at','time','checked_at','date']);
          const d = toDate(whenRaw);
          const row = document.createElement('div');
          row.className = 'log-row';
          row.innerHTML = ''
            + '<div><span class="chip ' + (ok?'ok':'err') + '">' + (ok?'SUCCESS':'ERROR') + '</span></div>'
            + '<div>' + (d ? (('0'+d.getDate()).slice(-2)+'/'+('0'+(d.getMonth()+1)).slice(-2)+'/'+d.getFullYear()) : '--') + ' ' + (d?(''):'') + '</div>'
            + '<div>' + (code!=null ? ('HTTP ' + code) : '--') + '</div>'
            + '<div>' + (rt!=null ? (rt + 'ms') : '--') + '</div>'
            + '<div>' + (d ? (('0'+d.getHours()).slice(-2)+':'+('0'+d.getMinutes()).slice(-2)+':'+('0'+d.getSeconds()).slice(-2)) : '--') + '</div>';
          logsList.appendChild(row);
        }
      }catch(e){
        logsList.innerHTML = '<div class="empty">Falha ao carregar logs.</div>';
      }
    }

    let ws = null;
    function connectWS(){
      if(ws) { try{ ws.close(); }catch{} }
      ws = new WebSocket(wsUrl());
      ws.onmessage = (ev) => {
        try{
          const m = JSON.parse(ev.data);
          if(m.kind === 'log'){
            if(m.targetId!=null){
              lastOk.set(m.targetId, !!m.ok);
              lastLatency.set(m.targetId, m.rt != null ? m.rt : null);
              if(m.when!=null){
                const d = toDate(m.when);
                if(d) lastWhen.set(m.targetId, d);
              } else if(m.ts!=null){
                const d = toDate(m.ts);
                if(d) lastWhen.set(m.targetId, d);
              }
            }
            renderCards();
          }
          if(m.kind === 'control' && m.scope === 'target'){
            loadTargets();
          }
        }catch{}
      };
      ws.onclose = () => setTimeout(connectWS, 2000);
    }

    loadTargets().then(connectWS);
  </script>
</body>
</html>
